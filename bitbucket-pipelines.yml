# Laravel pipelines https://confluence.atlassian.com/bitbucket/laravel-with-bitbucket-pipelines-913473967.html
#
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
#image: php:7.1.1


# Bitbucket Pipelines now includes the option to allocate additional resources.
# By specifying the size of '2x', your pipeline will include double the resources (eg. 4GB memory â†’ 8GB memory).
#options:
#  size: 2x

pipelines:
  branches:
    development:
      - step:
          name: Envoy deploy to Latest
          image:
            name: mcuyar/docker-envoy
          script:
            - envoy run deployBranch --host=$HOST --user=$USER --php=php --code_directory=$LATEST --docker=$DOCKER --workspace_user=$WORKSPACE_USER --workspace=$WORKSPACE_LATEST --branch=development

      - step:
          name: Promote to Stage
          deployment: staging # can be test, staging or production.
          trigger: manual  # Uncomment to make this a manual deployment.
          name: Envoy deploy to Stage
          image:
            name: mcuyar/docker-envoy
          script:
            - envoy run deployBranch --host=$HOST --user=$USER --php=php --code_directory=STAGE --docker=$DOCKER --workspace_user=$WORKSPACE_USER --workspace=$WORKSPACE_STAGE --branch=stage

      - step:
          name: Promote to Production
          deployment: production # can be test, staging or production.
          trigger: manual  # Uncomment to make this a manual deployment.
          name: Envoy deploy to Production
          image:
            name: mcuyar/docker-envoy
          script:
            - envoy run deployBranch --host=$HOST --user=$USER --php=php --code_directory=STAGE --docker=$DOCKER --workspace_user=$WORKSPACE_USER --workspace=$WORKSPACE_PRODUCTION --branch=stage
